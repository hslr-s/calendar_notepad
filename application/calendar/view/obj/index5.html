<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{$title??''} - 日历记事本</title>
    <link rel="stylesheet" type="text/css" href="/static/layui/css/layui.css" />
    <!-- <link rel="stylesheet" href="https://www.jq22.com/jquery/bootstrap-3.3.4.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="/static/calendar/jqFullCalendar/css/fullcalendar.css" /> -->
    <link rel="stylesheet" type="text/css" href="/static/calendar/jqFullCalendar/css/main.min.css" />
    <!-- <link rel="stylesheet" type="text/css" href="/static/calendar/jqFullCalendar/css/index.css"/> -->
    <link rel="stylesheet" type="text/css" href="/calendar/style/getStyleText/style.css"/>
    <style>
        html,body{
            background: #f2f2f2;
        }
        #calendar {
            max-width: 1200px;
            margin: 20px auto 0;
        }

        .event-btn{
            display: inline-block;
            padding: 5px;
            border-radius: 5px;
        }
        
        .box{
            height: 100%;
            border: 1px solid #f2f2f2;
            box-shadow: 0 0 2px #888;
            border-radius: 10px;
            padding: 15px;
            background: white;
            display: inline-block;
            margin: 25px;
            width: 90%;
        }
        .box-p{
            height: 100%;
            width: 100%;
            text-align: center;
        }
        .fc-button-group .fc-button{
            height: 35px;
        }
        .title{
            color:#a7a7a7;
            border-bottom: 1px solid #f3f3f3;
            /*font-weight: 700;*/
        }
        .fc-event-title{
            /**/
        }
        /* 月视图事件超出部分省略号显示 */
        .fc-daygrid-block-event .fc-event-main .event-content{
            overflow: hidden;
            text-overflow:ellipsis;
            white-space: nowrap;
            padding: 5px;
            /*margin: 3px;*/
            display: block;
            /*font-size: 14px;*/
        }
        .fc-list-event-graphic,.fc-list-event-time{
            display: none;
        }
        #calendar{
            max-width: none;
        }
        .fc-theme-standard td:hover, .fc-theme-standard th:hover{
            color: black;
        }

    </style>
    
</head>
<body>
    <!-- <button id='test-btn'>扭扭捏捏</button> -->
    <!-- <a href="/calendar/object/set?obj_id={:input('get.obj_id')}">设置</a> -->
    
    <div class="box-p layui-hide">
        <div class="box">
            <header class="nav"><div class="title">{$title??""} {$note?'('.$note.')':''}</div></header>
            <!-- 主体 -->
            <div class="main layui-hide">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
    
    
    <!-- 添加编辑模板 -->
    <script type="text/html" id='form_input'>
        
        <div class="layui-form layui-form-pane" action="" style="padding: 20px">
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">事件标题</label>
                <div class="layui-input-block">
                    <!-- <input type="text" name="title" lay-verify="title" id='text_input' autocomplete="off" placeholder="请输入标题" class="layui-input"> -->
                    <textarea name="desc" name="title" lay-verify="title" class="layui-textarea"  placeholder="请输入标题" id="text_input"></textarea>
                </div>
            </div>
            
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">详情</label>
                <div class="layui-input-block">
                    <textarea name="desc" placeholder="可选" class="layui-textarea" id="content"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">风格</label>
                <div class="layui-input-block">
                    <!-- <div class="event-btn green">演示风格</div> -->
                    <select name="class_name" id="class_select">
                        <option value="">默认</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">颜色值</label>
                <div style="margin-left: 30px;">
                    <div class="layui-input-inline" style="width: 120px;">
                        <input type="text" value="" readonly="" id="color_input" placeholder="可选（选择后类失效）" class="layui-input">
                    </div>
                    <div class="layui-inline" style="left: -11px;">
                        <div id="test-form"></div>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">开始时间</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" readonly="" id="start_time" placeholder="yyyy-MM-dd">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">结束时间</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" readonly="" id="end_time" placeholder="yyyy-MM-dd">
                </div>
            </div>
          <div class="layui-form-item">
            <div class="layui-input-block">
              <button type="submit" class="layui-btn" lay-submit="" id="submit" lay-filter="demo1">保存</button>
              <button type="reset" class="layui-btn layui-btn-danger" id="delete">删除</button>
            </div>
          </div>
        </div>
         
    </script>
    
    <script type="text/javascript" src="/static/calendar/jqFullCalendar/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="/static/layui/layui.js" ></script>
    <script type="text/javascript" src="/static/calendar/jqFullCalendar/js/bootstrap.min.js" ></script>
    <script type="text/javascript" src="/static/calendar/jqFullCalendar/js/moment.min.js" ></script><!-- 日期处理时间工具 -->
    <!-- <script type="text/javascript" src="/static/calendar/jqFullCalendar/js/fullcalendar.min.js" ></script> -->
    <script type="text/javascript" src="/static/calendar/jqFullCalendar/js/main.min.js" ></script>
    <script>
        var password='{$password??0}';
        layui.use(['layer','laydate','form','colorpicker','jquery'],function(){
            var layer=layui.layer,laydate=layui.laydate,colorpicker=layui.colorpicker,form=layui.form;
            // $=jQuery=layui.jquery;
            var calendar=null;
            var get = moment().format('YYYY-MM-DD');
            var config=null;
            // var passwordPass=0;//密码验证通过
            
            if(password=="1"){
                layer.prompt({title: '请输入查看 {$title??""} 所需的密码', formType: 1,shade:[0.8,'#fff'],closeBtn:false,btn2:function(a,b,c){
                    goToObjList()
                },success:function(elem){
                    // console.log(pass, index);
                    $("input.layui-layer-input").on('keydown',function(e){
                        if (e.which == 13) {
                            post('/calendar/objectapi/pwdCheck?obj_id={:input("get.obj_id")}',{'pwd':$(this).val()},function(res){
                                if(res.code==1){
                                    layer.closeAll();
                                    start()
                                    passwordPass=1
                                }else{
                                    layer.msg('密码错误')
                                }
                            })
                        }
                    })
                }}, function(pass, index){
                    post('/calendar/objectapi/pwdCheck?obj_id={:input("get.obj_id")}',{'pwd':pass},function(res){
                        if(res.code==1){
                            start()
                            passwordPass=1
                            layer.close(index);
                        }else{
                            layer.msg('密码错误')
                        }
                    })
                });
            }else{
                start();
            }
            

            function start(){
                post('/calendar/objectapi/getConfig?obj_id={:input("get.obj_id")}',[],function(res){
                    config=res.data;
                    render(res.data)
                    $('.box-p').removeClass('layui-hide');
                })
            }

            function goToObjList(){
                var last_url=document.referrer;
                var res=last_url.search(/calendar/i)
                // 如果上一页不是项目列表，则跳转，如果是则返回
                if(res==-1){
                    location.href="/calendar";
                }else{
                    window.history.back(-1); 
                }
            }
            
            function render(config){
                var config=config||{};
                var obj2={
                    height: $(window).height()-125,
                    expandRows: false,
                    locale: 'zh-cn',
                    fixedWeekCount:false,//false:根据实际情况4 5 6周
                    firstDay: (Number(config.firstDay)?1:0),//一周第一天显示日
                    displayEventTime:(Number(config.c_dayTimeDisplay)==0?false:true),
                    displayEventEnd: (Number(config.c_dayTimeDisplay)==2?true:false),
                    weekNumbers: Number(config.weekNumbers),
                    weekText:'',
                    customButtons: {
                        setting: {
                            text: '设置',
                            click: function() {
                                console.log('设置按钮');
                                layer.open({
                                    type: 2,
                                    title: '设置项目',
                                    shadeClose: true,
                                    shade: false,
                                    maxmin: true, //开启最大化最小化按钮
                                    area: ['500px', '600px'],
                                    content: "/calendar/obj/set?obj_id={:input('get.obj_id')}"
                                });
                                // location.href="/calendar/object/set?obj_id={:input('get.obj_id')}";
                            }
                        },
                        list: {
                            text: '返回列表',
                            click: function() {
                                goToObjList();
                            }
                        }
                    },
                    buttonText:{
                        today:    '今天',
                        month:    '月',
                        week:     '周',
                        day:      '天',
                        listMonth:  '月日程'
                    },
                    // slotMinTime: '08:00',
                    // slotMaxTime: '20:00',
                    headerToolbar: {
                      left: 'list,setting',
                      center: 'title',
                      right: 'prev,next,today dayGridMonth,timeGridWeek,listMonth'
                    },
                    initialView: 'dayGridMonth',
                    initialDate: get,
                    navLinks: true, // can click day/week names to navigate views
                    editable: true,
                    selectable: true,
                    nowIndicator: true,
                    eventDisplay:'block',
                    dayMaxEvents: Number(config.eventLimit), // allow "more" link when too many events
                    allDaySlot:false,
                    events: function(info, successCallback, failureCallback){  
                        // https://fullcalendar.io/docs/events-function
                        console.log('获取数据');
                        var start =info.start.valueOf()
                        var end =info.end.valueOf()

                        // console.log(,moment(end).utc().format('YYYY-MM-DD HH:mm:ss'));
                        var postdata={}
                        postdata['start_time']=moment(start).format('YYYY-MM-DD HH:mm:ss');
                        postdata['end_time']=moment(end).format('YYYY-MM-DD HH:mm:ss');
                        if(!config.holidayBackground || config.holidayBackground==""){
                            // 不显示假期背景
                            post('/calendar/eventapi/getList?obj_id={:input("get.obj_id")}',postdata,function(data1){
                                successCallback(data1);
                            })
                        }else{
                            // 获取假期数据
                            post('/calendar/eventapi/getHolidayList?obj_id={:input("get.obj_id")}',postdata,function(data){
                                for (var i = 0; i < data.length; i++) {
                                    data[i].display='background';
                                    data[i].color=config.holidayBackground;
                                    // data[i].overlap=false;
                                    data[i].start=moment(data[i].start).format('YYYY-MM-DD')
                                    data[i].end=moment(data[i].end).format('YYYY-MM-DD')
                                }
                                // 获取时间数据
                                post('/calendar/eventapi/getList?obj_id={:input("get.obj_id")}',postdata,function(data1){
                                    // console.log(data);
                                    data.push.apply(data,data1);
                                    // console.log(data);
                                    successCallback(data);
                                })
                            })
                        }
                        
                        
                    },
                    select: function(arg) {
                        // 判断只读模式
                        if(Number(config.c_onlyRead)){
                            return false;
                        }
                        // 选择
                        // var title = prompt('Event Title:');
                        // if (title) {
                        //     calendar.addEvent({
                        //         title: title,
                        //         start: arg.start,
                        //         end: arg.end,
                        //         allDay: arg.allDay
                        //     })
                        // }
                        // calendar.unselect()
                        var data={};       
                        console.log(arg);  
                        data['start']=moment(arg.start).format('YYYY-MM-DD HH:mm:ss');
                        data['end']=moment(arg.end).format('YYYY-MM-DD HH:mm:ss');
                        // moment().format('YYYY-MM-DD HH:mm:ss'); // "2020-07-30 21:11:01"
                        openInfo(data);
                    },
                    eventClick: function(arg) {
                        // if (confirm('Are you sure you want to delete this event?')) {
                        //     arg.event.remove()
                        // }
                        //点击已有日程事件
                        console.log(arg);
                        var event=arg.event;
                        console.log(event);

                        var data={};         
                        data['start']=moment(event.start).format("YYYY-MM-DD HH:mm:ss");
                        data['end']=moment(event.end).format("YYYY-MM-DD HH:mm:ss");
                        data['title']=event.title;
                        data['color']=event.backgroundColor;
                        data['className']=event.classNames[0];
                        data['content']=event.extendedProps.content;
                        console.log(data);
                        // moment().format('YYYY-MM-DD HH:mm:ss'); // "2020-07-30 21:11:01"
                        openInfo(data,event);
                    },
                    eventDrop: function(info) {
                        var event=info.event;
                        console.log(event);

                        // alert(info.event.title + " was dropped on " + info.event.start.toISOString());

                        // if (!confirm("Are you sure about this change?")) {
                        //   info.revert();
                        // }
                        var data={};         
                        data['startTime']=moment(event.start).format("YYYY-MM-DD HH:mm:ss");
                        data['endTime']=moment(event.end).format("YYYY-MM-DD HH:mm:ss");
                        data['title']=event.title;
                        data['color']=event.color;
                        data['className']=event.classNames[0];
                        data['event_id']=event.id;
                        data['content']=event.extendedProps.content;
                        post('/calendar/eventapi/update?obj_id={:input("get.obj_id")}',data,function(res){
                            console.log(res);
                        })
                    },
                    eventResize:function(info) {
                        var event=info.event; 
                        // console.log(event, delta, revertFunc, jsEvent, ui, view );
                        //日程拖拽尺寸改变停止，并且时间改变时触发，ayDelta日程前后移动了多少天
                        var data={};         
                        data['startTime']=moment(event.start).format("YYYY-MM-DD HH:mm:ss");
                        data['endTime']=moment(event.end).format("YYYY-MM-DD HH:mm:ss");
                        data['title']=event.title;
                        data['color']=event.color;
                        data['className']=event.classNames[0];
                        data['event_id']=event.id;
                        data['content']=event.extendedProps.content;
                        post('/calendar/eventapi/update?obj_id={:input("get.obj_id")}',data,function(res){
                            console.log(res);
                        })
                    },
                    eventTimeFormat: { // like '14:30:00'
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    },
                    dayCellContent:function(arg){
                        // 修改日标题 例：26日
                        // console.log(arg);
                        // arg.dayNumberText='5';
                        // console.log(arg);
                        if(arg.isToday==true){
                            arg.dayNumberText="(今)"+arg.dayNumberText
                        }
                        return { html: '<a>'+arg.dayNumberText+'</a>' };
                    },
                    eventMouseEnter:function(arg){
                        // 鼠标放在事件上
                        // console.log(arg);
                    },
                    eventContent:function(arg){
                        // 事件内容渲染
                        // console.log(arg);

                        // 判断是否为背景
                        if(arg.event.display!=='background'){
                            var start = moment(arg.event.start).format("HH:mm")
                            var time="";
                            if(Number(config.c_dayTimeDisplay)==2){
                                var end = moment(arg.event.end).format("HH:mm")
                                time=start +'-'+ end;
                            }else if(Number(config.c_dayTimeDisplay)==1){
                                time=start;
                            }
                            
                            return { html: '<b class="event-content" title="'+arg.event.title+'">'+time+' '+arg.event.title+'</b>' };
                        }
                        
                    },
                    loading: function(isLoading, index) {
                        console.log(isLoading, index);
                        if(isLoading){
                            index = layer.load(1, {
                              shade: [0.5,'#000']
                            });
                        }else{
                            $('.main').removeClass('layui-hide');
                            layer.closeAll()
                        }
                        
                    }
                }
                calendar = new FullCalendar.Calendar(document.getElementById('calendar'), obj2);

                calendar.render();
            }

            // 打开详情窗口
            function openInfo(data,event){
                var title=data.title||'';
                var color=data.color||'';
                if(!Number(config.c_onlyRead)){
                    var layeropentitle=(event?'修改事件':'新增事件');
                }else{
                    var layeropentitle='详情';
                }
                layer.open({
                        type: 1,
                        shade: 0.5,
                        title: layeropentitle,
                        content: $('#form_input').html(),
                        success:function(){
                            // 如果只读模式需要删除不需要的元素
                            if(Number(config.c_onlyRead)){
                                $('#class_select').parents('.layui-form-item').remove();
                                $('#color_input').parents('.layui-form-item').remove();
                                $('#submit').parents('.layui-form-item').remove();
                                $('#text_input').attr('readonly','');
                                $('#content').attr('readonly','');

                            }else{
                                laydate.render({
                                    elem: '#start_time'
                                    ,type: 'datetime'
                                });
                                laydate.render({
                                    elem: '#end_time'
                                    ,type: 'datetime'
                                });
                            }
                            // 获取风格列表
                            post('/calendar/style/getStyleList','',function(res){
                                if(res.code==1){
                                    for (var i = 0; i < res.data.length; i++) {
                                        $('#class_select').append('<option value="'+res.data[i]['name']+'">'+res.data[i]['name_cn']+'</option>')
                                    }
                                    
                                    $('#start_time').val(data.start)
                                    $('#end_time').val(data.end)
                                    $('#color_input').val(color);
                                    $('#text_input').val(title);
                                    $('#class_select').val(data['className']);
                                    $('#content').val(data['content']);
                                    form.render()
                                }
                            })
                            

                            

                            colorpicker.render({
                                elem: '#test-form'
                                ,color: color
                                ,done: function(color){
                                    $('#color_input').val(color);
                                }
                            });
                            if(!event || !event.id){
                                $("#delete").remove();
                            }
                            
                            // 删除事件
                            $('#delete').click(function(){
                                var postdata={};
                                layer.confirm('确定删除此日程吗', {
                                    btn: ['确定','取消'] //按钮
                                }, function(){
                                    postdata["event_id"]=event.id;
                                    post('/calendar/eventapi/delete?obj_id={:input("get.obj_id")}',postdata,function(res){
                                        if(res.code==1){
                                            event.remove()
                                            layer.closeAll();
                                            // location.href="?obj_id={:input('get.obj_id')}&date="   
                                            // calendar.fullCalendar('refetchEvents');

                                        }else{
                                            layer.msg('删除失败')
                                        }
                                    })
                                })
                                
                            })
                            // 监听保存
                            $('#submit').click(function(){
                                var d={       
                                    //一旦日历重新取得日程源，则原有日程将消失，当指定stick为true时，日程将永久的保存到日历上
                                    title: $('#text_input').val(),
                                    start: $('#start_time').val(),
                                    end: $('#end_time').val(),
                                    content:$('#content').val(),
                                    allDay: data.allDay,
                                    // rendering: 'background',
                                    block: true,
                                    className:$('#class_select').val(),
                                    color:$('#color_input').val(),
                                }
                                
                                if(d.title==''){
                                    layer.msg('请填写标题')
                                    return;
                                }
                                    
                                var postdata={};
                                if(event){
                                    d['source']=event.source
                                }
                                postdata['startTime'] =d.start;
                                postdata['endTime'] =d.end;
                                postdata['title'] =d.title;
                                postdata['className'] =d.className;
                                postdata['color'] =d.color;
                                postdata['content'] =d.content;
                                if(event && event.id){
                                    postdata['event_id'] =event.id;
                                    post('/calendar/eventapi/update?obj_id={:input("get.obj_id")}',postdata,function(res){
                                        if(res.code==1){
                                            // calendar.fullCalendar('renderEvent',d,false);
                                            calendar.refetchEvents()
                                            layer.closeAll();
                                        }else{
                                            layer.msg('修改失败')
                                        }
                                    })
                                }else{
                                    
                                    post('/calendar/eventapi/add?obj_id={:input("get.obj_id")}',postdata,function(res){
                                        if(res.code==1){
                                            d['event_id']=res.id;
                                            calendar.refetchEvents()
                                            // calendar.fullCalendar('renderEvent',d,false);
                                            layer.closeAll();
                                        }else{
                                            layer.msg('添加失败')
                                        }
                                    })
                                }
                                

                                
                            })

                        }
                    });
            

            }

            function setOption(k,v){
                calendar.fullCalendar('option', k, v);// 动态设置参数
            }

            $('#test-btn').click(function(){
                    console.log('安妮');
                    setOption('firstDay',1);
                    // render()
                    // calendar.fullCalendar('refetchEvents');// 刷新数据
                    // $('#calendar').fullCalendar('option', 'firstDay', 1);// 动态设置参数
                    // $('#calendar').fullCalendar('render'); // 重新渲染
                    // calendar.getTopLevelResources()
            })
            function post(url,data,callback){  
                 $.ajax({
                    type : "post",
                    url : url,
                    dateType:'json',
                    data:data,
                    success : function(res) {
                        callback(res);
                    }
                 });
            }
        });

        
    </script>
</body>
</html>
